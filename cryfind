#!/usr/bin/env python3
from docopt import docopt

from crylib import *
from crylib.constants.CryptoConstants import constants
from crylib.constants.CryptoAPI import apinames

__doc__ = f"""Usage: cryfind [-s SOURCES] [-m METHODS] [-c CONSTANTS] [-aexy] <filename>

-h --help           Show this screen
-s SOURCES          Sources to be searched, could be : plain,stackstrings or all [default: plain]
-m METHODS          Methods to be used, could be : string,yara,peimport or all [default: string]
-c CONSTANTS        Constants to be used, only for -m string, could be : crypto,apiname or all [default: crypto]
-a --all            Use all sources and methods and constants
-y --summary        Only show summary
"""

def banner():
    print('''
   ▄▄· ▄▄▄   ▄· ▄▌·▄▄▄▪   ▐ ▄ ·▄▄▄▄
  ▐█ ▌▪▀▄ █·▐█▪██▌▐▄▄·██ •█▌▐███▪ ██
  ██ ▄▄▐▀▀▄ ▐█▌▐█▪██▪ ▐█·▐█▐▐▌▐█· ▐█▌
  ▐███▌▐█•█▌ ▐█▀·.██▌.▐█▌██▐█▌██. ██
  ·▀▀▀ .▀  ▀  ▀ • ▀▀▀ ▀▀▀▀▀ █▪▀▀▀▀▀•
''')

def main():
    arguments = docopt(__doc__)
    filename = arguments['<filename>']
    summary = arguments['--summary']

    banner()
    
    try:
        with open(filename, 'rb') as f:
            binary = f.read()
    except FileNotFoundError:
        print(f"\n[-] '{filename}' file not found")
        exit()
    
    print('[+] Searching For Crypto Constants...')
    results = find_const(binary, constants)
    for result in results:
        print(f'[+] {result.name}')
        if not summary:
            for group in result.groups:
                print('    - ' + {0: 'fullword', 8: 'qword', 4: 'dword'}[group.blocksize])
                for value in group.values:
                    print(f'        | [{value.index}] {value.value.hex()} ({value.encoding}): 0x{value.address:x}')
        print()
    if not results:
        print('[-] Nothing Found')

    print('[+] Searching For Crypto API Names...')
    results = find_api(binary, apinames)
    for result in results:
        print(f'[+] DLL - {result.name}')
        for group in result.groups:
            for value in group.values:
                print(f'    | {value.value.decode()}: 0x{value.address:x}')
        print()
    if not results:
        print('[-] Nothing Found')

if __name__ == '__main__':
    try:
        main()
    except KeyboardInterrupt:
        print("\n[-] You Pressed Ctrl-C")
